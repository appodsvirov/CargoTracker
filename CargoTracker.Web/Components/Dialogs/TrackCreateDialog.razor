@using CargoTracker.Web.Domain.Models
@inject Radzen.DialogService Dialogs

<RadzenTemplateForm TItem="TrackModel" Data="model" Submit="OnValidSubmit">
    <ChildContent>
        <RadzenStack Orientation="Orientation.Vertical" Gap="10px" Style="width: 450px; max-width: 100%">
            <h3>New track</h3>

            <RadzenFieldset Text="Track details" Toggleable="false">
                <RadzenStack Orientation="Orientation.Vertical" Gap="10px">
                    <RadzenTextBox @bind-Value="model.Location" Name="Location" Placeholder="Location" Style="width:100%" />
                    <RadzenRequiredValidator Component="Location" Text="Location is required" />

                    <label>Timestamp</label>
                    <RadzenDatePicker TValue="DateTimeOffset" @bind-Value="model.Timestamp" Name="Timestamp" DateFormat="yyyy-MM-dd HH:mm" ShowTime="true" Style="width:100%" />
                </RadzenStack>
            </RadzenFieldset>

            <RadzenStack Orientation="Orientation.Horizontal" Gap="10px" JustifyContent="JustifyContent.End">
                <RadzenButton Text="Cancel" ButtonStyle="ButtonStyle.Light" Click="OnCancel" Icon="close" />
                <RadzenButton Text="Create" ButtonStyle="ButtonStyle.Primary" Icon="check" Type="ButtonType.Submit" />
            </RadzenStack>
        </RadzenStack>
    </ChildContent>
</RadzenTemplateForm>

@code {
    [Parameter] public Guid CargoId { get; set; }

    private TrackModel model = new();

    protected override void OnInitialized()
    {
        model.Timestamp = DateTimeOffset.UtcNow;
    }

    private void OnCancel() => Dialogs.Close(null);

    private void OnValidSubmit(TrackModel _)
    {
        var track = new Track
        {
            CargoId = CargoId,
            Timestamp = model.Timestamp,
            Location = model.Location.Trim()
        };
        Dialogs.Close(track);
    }

    private sealed class TrackModel
    {
        [System.ComponentModel.DataAnnotations.Required]
        public string Location { get; set; } = string.Empty;
        public DateTimeOffset Timestamp { get; set; } = DateTimeOffset.UtcNow;
    }
}

@using CargoTracker.Web.Domain.Models
@inject Radzen.DialogService Dialogs
@inject CargoTracker.Web.Domain.Abstractions.IDataManagerApiClient Api

<RadzenTemplateForm TItem="NewCargoModel" Data="model" Submit="OnValidSubmit">
    <ChildContent>
        <RadzenStack Orientation="Orientation.Vertical" Gap="10px" Style="width: 500px; max-width: 100%">
            <h3>New cargo</h3>

            <RadzenFieldset Text="Basic info" Toggleable="false">
                <RadzenStack Orientation="Orientation.Vertical" Gap="10px">
                    <RadzenTextBox @bind-Value="model.Name" Name="Name" Placeholder="Name" Style="width:100%" />
                    <RadzenRequiredValidator Component="Name" Text="Name is required" />

                    <RadzenTextBox @bind-Value="model.From" Name="From" Placeholder="From" Style="width:100%" />
                    <RadzenRequiredValidator Component="From" Text="'From' is required" />

                    <RadzenTextBox @bind-Value="model.To" Name="To" Placeholder="To" Style="width:100%" />
                    <RadzenRequiredValidator Component="To" Text="'To' is required" />
                </RadzenStack>
            </RadzenFieldset>

            <RadzenFieldset Text="Schedule" Toggleable="false">
                <RadzenStack Orientation="Orientation.Vertical" Gap="10px">
                    <label>Departure</label>
                    <RadzenDatePicker TValue="DateTimeOffset" @bind-Value="model.DepartureAt" Name="DepartureAt" DateFormat="yyyy-MM-dd HH:mm" ShowTime="true" Style="width:100%" />

                    <label>ETA</label>
                    <RadzenDatePicker TValue="DateTimeOffset" @bind-Value="model.EstimatedArrivalAt" Name="EstimatedArrivalAt" DateFormat="yyyy-MM-dd HH:mm" ShowTime="true" Style="width:100%" />
                    <RadzenValidationSummary />
                </RadzenStack>
            </RadzenFieldset>

            <RadzenStack Orientation="Orientation.Horizontal" Gap="10px" JustifyContent="JustifyContent.End">
                <RadzenButton Text="Cancel" ButtonStyle="ButtonStyle.Light" Click="OnCancel" Icon="close" />
                <RadzenButton Text="Create" ButtonStyle="ButtonStyle.Primary" Icon="check" Type="ButtonType.Submit" />
            </RadzenStack>
        </RadzenStack>
    </ChildContent>
</RadzenTemplateForm>

@code {
    private NewCargoModel model = new();

    protected override void OnInitialized()
    {
        // Defaults: current time
        model.DepartureAt = DateTimeOffset.UtcNow;
        model.EstimatedArrivalAt = DateTimeOffset.UtcNow;
    }

    private void OnCancel()
    {
        Dialogs.Close(null);
    }

    private void OnValidSubmit(NewCargoModel _)
    {
        // Cross-field validation already performed by IValidatableObject
        var cargo = new Cargo
        {
            // Id intentionally not set by user
            Name = model.Name.Trim(),
            From = model.From.Trim(),
            To = model.To.Trim(),
            DepartureAt = model.DepartureAt,
            EstimatedArrivalAt = model.EstimatedArrivalAt
        };

        Dialogs.Close(cargo);
    }

    private sealed class NewCargoModel : System.ComponentModel.DataAnnotations.IValidatableObject
    {
        [System.ComponentModel.DataAnnotations.Required]
        public string Name { get; set; } = string.Empty;

        [System.ComponentModel.DataAnnotations.Required]
        public string From { get; set; } = string.Empty;

        [System.ComponentModel.DataAnnotations.Required]
        public string To { get; set; } = string.Empty;

        public DateTimeOffset DepartureAt { get; set; } = DateTimeOffset.UtcNow;
        public DateTimeOffset EstimatedArrivalAt { get; set; } = DateTimeOffset.UtcNow;

        public IEnumerable<System.ComponentModel.DataAnnotations.ValidationResult> Validate(System.ComponentModel.DataAnnotations.ValidationContext validationContext)
        {
            if (EstimatedArrivalAt < DepartureAt)
            {
                yield return new System.ComponentModel.DataAnnotations.ValidationResult(
                    "ETA must be greater than or equal to Departure",
                    new[] { nameof(EstimatedArrivalAt) }
                );
            }
        }
    }
}

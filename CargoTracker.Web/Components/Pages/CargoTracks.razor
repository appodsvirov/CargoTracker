@page "/cargos/{CargoId:guid}/tracks"
@using CargoTracker.Web.Domain.Models
@using CargoTracker.Web.Components.Shared
@inject CargoTracker.Web.Domain.Abstractions.IDataManagerApiClient Api
@inject Radzen.NotificationService Notifications
@inject NavigationManager Nav
@inject CargoTracker.Web.Domain.Abstractions.ITrackFilterService FilterService
@inject Radzen.DialogService Dialogs

<PageTitle>Tracks</PageTitle>

<RadzenStack Orientation="Orientation.Vertical" Gap="16px">
    <!-- Cargo card on top -->
    <RadzenCard Style="max-width: 900px">
        <ChildContent>
            @if (cargo is null)
            {
                <RadzenText Text="Cargo not found"/>
            }
            else
            {
                <RadzenStack Orientation="Orientation.Vertical" Gap="8px">
                    <RadzenStack Orientation="Orientation.Horizontal" Gap="10px" AlignItems="AlignItems.Center">
                        <h3 style="margin:0">@cargo.Name</h3>
                        <RadzenBadge Text=@cargo.Id.ToString() Style="background:#eee;color:#444" />
                    </RadzenStack>

                    <RadzenRow>
                        <RadzenColumn Size="6">
                            <RadzenFieldset Text="Route" Toggleable="false">
                                <div><b>From:</b> @cargo.From</div>
                                <div><b>To:</b> @cargo.To</div>
                            </RadzenFieldset>
                        </RadzenColumn>
                        <RadzenColumn Size="6">
                            <RadzenFieldset Text="Schedule" Toggleable="false">
                                <div><b>Departure:</b> @cargo.DepartureAt.ToLocalTime().ToString("g")</div>
                                <div><b>ETA:</b> @cargo.EstimatedArrivalAt.ToLocalTime().ToString("g")</div>
                            </RadzenFieldset>
                        </RadzenColumn>
                    </RadzenRow>
                </RadzenStack>
            }
        </ChildContent>
    </RadzenCard>

    <!-- Controls and tracks below -->
    <RadzenStack Orientation="Orientation.Horizontal" Gap="10px" AlignItems="AlignItems.Center">
        <RadzenButton Text="Back" Icon="arrow_back" Click="GoBack" ButtonStyle="ButtonStyle.Light" />
        <RadzenTextBox @bind-Value="filterQuery" Placeholder="Search..." Style="width:300px" Change=OnFilterQueryChanged />
        <RadzenButton Text="Settings" Icon="settings" Click="OpenFilterSettings" ButtonStyle="ButtonStyle.Light" />
    </RadzenStack>

    <RadzenDataGrid Data="filtered" TItem="Track" AllowPaging="true" PageSize="10" AllowSorting="true">
        <Columns>
            <RadzenDataGridColumn TItem="Track" Title="Id" Width="100px" TextAlign="TextAlign.Center">
                <Template Context="t">
                    <CopyToClipboardButton TextToCopy="@t.Id.ToString()"/>
                </Template>
            </RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="Track" Title="Timestamp">
                <Template Context="t">
                    <LocalDateTime Value="@t.Timestamp" />
                </Template>
            </RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="Track" Property="Location" Title="Location" />
        </Columns>
    </RadzenDataGrid>
</RadzenStack>

@code {
    [Parameter] public Guid CargoId { get; set; }

    private Cargo? cargo;
    private IReadOnlyList<Track> all = Array.Empty<Track>();
    private IReadOnlyList<Track> filtered = Array.Empty<Track>();
    private string? filterQuery;
    private CargoTracker.Web.Domain.Models.TrackFilterOptions filterOptions = CargoTracker.Web.Domain.Models.TrackFilterOptions.All;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            cargo = await Api.GetCargoAsync(CargoId);
            if (cargo is null)
            {
                Notifications.Notify(Radzen.NotificationSeverity.Warning, "Cargo not found");
            }

            var tracks = await Api.GetTracksAsync();
            all = tracks.Where(t => t.CargoId == CargoId).ToList();
            ApplyFilter();
        }
        catch (Exception ex)
        {
            Notifications.Notify(Radzen.NotificationSeverity.Error, "Failed to load tracks", ex.Message);
        }
    }

    private void ApplyFilter()
    {
        filtered = FilterService.Filter(all, filterQuery, filterOptions);
    }

    private Task OnFilterQueryChanged(object? _)
    {
        ApplyFilter();
        return Task.CompletedTask;
    }

    private async Task OpenFilterSettings()
    {
        var result = await Dialogs.OpenAsync<CargoTracker.Web.Components.Dialogs.TrackFilterSettingsDialog>(
            title: "Filter settings",
            options: new Radzen.DialogOptions { Width = "500px", Resizable = true, Draggable = true },
            parameters: new Dictionary<string, object?>
            {
                [nameof(CargoTracker.Web.Components.Dialogs.TrackFilterSettingsDialog.Options)] = filterOptions
            });

        if (result is CargoTracker.Web.Domain.Models.TrackFilterOptions opts)
        {
            filterOptions = opts;
            ApplyFilter();
        }
    }

    private Task OnFilterOptionsChanged()
    {
        ApplyFilter();
        return Task.CompletedTask;
    }

    private void GoBack()
    {
        Nav.NavigateTo("/cargos");
    }
}

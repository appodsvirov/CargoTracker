@page "/cargos/{CargoId:guid}/tracks"
@using CargoTracker.Web.Domain.Models
@inject CargoTracker.Web.Domain.Abstractions.IDataManagerApiClient Api
@inject Radzen.NotificationService Notifications
@inject NavigationManager Nav
@inject CargoTracker.Web.Domain.Abstractions.ITrackFilterService FilterService
@inject Radzen.DialogService Dialogs

<PageTitle>Tracks</PageTitle>

<RadzenStack Orientation="Orientation.Vertical" Gap="10px">
    <RadzenStack Orientation="Orientation.Horizontal" Gap="10px" AlignItems="AlignItems.Center">
        <RadzenButton Icon="arrow_back" Click="GoBack" ButtonStyle="ButtonStyle.Light" />
        <RadzenTextBox @bind-Value="filterQuery" Placeholder="Поиск..." Style="width:300px" Change=OnFilterQueryChanged />
        <RadzenButton Icon="settings" Click="OpenFilterSettings" ButtonStyle="ButtonStyle.Light" />
    </RadzenStack>

    <RadzenDataGrid Data="filtered" TItem="Track" RowHover="true" AllowPaging="true" PageSize="10" AllowSorting="true">
        <Columns>
            <RadzenDataGridColumn TItem="Track" Property="Id" Title="Id" />
            <RadzenDataGridColumn TItem="Track" Property="Timestamp" Title="Timestamp" />
            <RadzenDataGridColumn TItem="Track" Property="Location" Title="Location" />
        </Columns>
    </RadzenDataGrid>
</RadzenStack>

@code {
    [Parameter] public Guid CargoId { get; set; }

    private IReadOnlyList<Track> all = Array.Empty<Track>();
    private IReadOnlyList<Track> filtered = Array.Empty<Track>();
    private string? filterQuery;
    private CargoTracker.Web.Domain.Models.TrackFilterOptions filterOptions = CargoTracker.Web.Domain.Models.TrackFilterOptions.All;

    private string FilterSummary => $"Fields: {filterOptions}";

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var tracks = await Api.GetTracksAsync();
            all = tracks.Where(t => t.CargoId == CargoId).ToList();
            ApplyFilter();
        }
        catch (Exception ex)
        {
            Notifications.Notify(Radzen.NotificationSeverity.Error, "Не удалось загрузить треки", ex.Message);
        }
    }

    private void ApplyFilter()
    {
        filtered = FilterService.Filter(all, filterQuery, filterOptions);
    }

    private Task OnFilterQueryChanged(object? _)
    {
        ApplyFilter();
        return Task.CompletedTask;
    }

    private async Task OpenFilterSettings()
    {
        var result = await Dialogs.OpenAsync<CargoTracker.Web.Components.Dialogs.TrackFilterSettingsDialog>(
            title: "Настройки фильтра",
            options: new Radzen.DialogOptions { Width = "500px", Resizable = true, Draggable = true },
            parameters: new Dictionary<string, object?>
            {
                [nameof(CargoTracker.Web.Components.Dialogs.TrackFilterSettingsDialog.Options)] = filterOptions
            });

        if (result is CargoTracker.Web.Domain.Models.TrackFilterOptions opts)
        {
            filterOptions = opts;
            ApplyFilter();
        }
    }

    private Task OnFilterOptionsChanged()
    {
        ApplyFilter();
        return Task.CompletedTask;
    }

    private void GoBack()
    {
        Nav.NavigateTo("/cargos");
    }
}

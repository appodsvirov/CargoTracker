@page "/cargos/{CargoId:guid}/tracks"
@using CargoTracker.Web.Domain.Models
@inject CargoTracker.Web.Domain.Abstractions.IDataManagerApiClient Api
@inject Radzen.NotificationService Notifications
@inject NavigationManager Nav
@inject CargoTracker.Web.Domain.Abstractions.ITrackFilterService FilterService
@inject Radzen.DialogService Dialogs

<PageTitle>Tracks</PageTitle>

<RadzenStack Orientation="Orientation.Vertical" Gap="16px">
    <!-- Cargo card on top -->
    <RadzenCard Style="max-width: 900px">
        <ChildContent>
            @if (cargo is null)
            {
                <RadzenStack Orientation="Orientation.Horizontal" Gap="10px" AlignItems="AlignItems.Center">
                    <RadzenSkeleton Shape="SkeletonShape.Text" Width="200px" />
                    <RadzenSkeleton Shape="SkeletonShape.Text" Width="120px" />
                </RadzenStack>
            }
            else
            {
                <RadzenStack Orientation="Orientation.Vertical" Gap="8px">
                    <RadzenStack Orientation="Orientation.Horizontal" Gap="10px" AlignItems="AlignItems.Center">
                        <h3 style="margin:0">@cargo.Name</h3>
                        <RadzenBadge Text=@cargo.Id.ToString() Style="background:#eee;color:#444" />
                    </RadzenStack>

                    <RadzenRow>
                        <RadzenColumn Size="6">
                            <RadzenFieldset Text="Маршрут" Toggleable="false">
                                <div><b>Откуда:</b> @cargo.From</div>
                                <div><b>Куда:</b> @cargo.To</div>
                            </RadzenFieldset>
                        </RadzenColumn>
                        <RadzenColumn Size="6">
                            <RadzenFieldset Text="Сроки" Toggleable="false">
                                <div><b>Отправление:</b> @cargo.DepartureAt.ToLocalTime().ToString("g")</div>
                                <div><b>Прибытие:</b> @cargo.EstimatedArrivalAt.ToLocalTime().ToString("g")</div>
                            </RadzenFieldset>
                        </RadzenColumn>
                    </RadzenRow>
                </RadzenStack>
            }
        </ChildContent>
    </RadzenCard>

    <!-- Controls and tracks below -->
    <RadzenStack Orientation="Orientation.Horizontal" Gap="10px" AlignItems="AlignItems.Center">
        <RadzenButton Text="Назад" Icon="arrow_back" Click="GoBack" ButtonStyle="ButtonStyle.Light" />
        <RadzenTextBox @bind-Value="filterQuery" Placeholder="Поиск..." Style="width:300px" Change=OnFilterQueryChanged />
        <RadzenButton Text="Settings" Icon="settings" Click="OpenFilterSettings" ButtonStyle="ButtonStyle.Light" />
    </RadzenStack>

    <RadzenDataGrid Data="filtered" TItem="Track" RowHover="true" AllowPaging="true" PageSize="10" AllowSorting="true">
        <Columns>
            <RadzenDataGridColumn TItem="Track" Property="Id" Title="Id" />
            <RadzenDataGridColumn TItem="Track" Property="Timestamp" Title="Timestamp" />
            <RadzenDataGridColumn TItem="Track" Property="Location" Title="Location" />
        </Columns>
    </RadzenDataGrid>
</RadzenStack>

@code {
    [Parameter] public Guid CargoId { get; set; }

    private Cargo? cargo;
    private IReadOnlyList<Track> all = Array.Empty<Track>();
    private IReadOnlyList<Track> filtered = Array.Empty<Track>();
    private string? filterQuery;
    private CargoTracker.Web.Domain.Models.TrackFilterOptions filterOptions = CargoTracker.Web.Domain.Models.TrackFilterOptions.All;

    private string FilterSummary => $"Fields: {filterOptions}";

    protected override async Task OnInitializedAsync()
    {
        try
        {
            cargo = await Api.GetCargoAsync(CargoId);
            if (cargo is null)
            {
                Notifications.Notify(Radzen.NotificationSeverity.Warning, "Груз не найден");
            }

            var tracks = await Api.GetTracksAsync();
            all = tracks.Where(t => t.CargoId == CargoId).ToList();
            ApplyFilter();
        }
        catch (Exception ex)
        {
            Notifications.Notify(Radzen.NotificationSeverity.Error, "Не удалось загрузить данные", ex.Message);
        }
    }

    private void ApplyFilter()
    {
        filtered = FilterService.Filter(all, filterQuery, filterOptions);
    }

    private Task OnFilterQueryChanged(object? _)
    {
        ApplyFilter();
        return Task.CompletedTask;
    }

    private async Task OpenFilterSettings()
    {
        var result = await Dialogs.OpenAsync<CargoTracker.Web.Components.Dialogs.TrackFilterSettingsDialog>(
            title: "Настройки фильтра",
            options: new Radzen.DialogOptions { Width = "500px", Resizable = true, Draggable = true },
            parameters: new Dictionary<string, object?>
            {
                [nameof(CargoTracker.Web.Components.Dialogs.TrackFilterSettingsDialog.Options)] = filterOptions
            });

        if (result is CargoTracker.Web.Domain.Models.TrackFilterOptions opts)
        {
            filterOptions = opts;
            ApplyFilter();
        }
    }

    private Task OnFilterOptionsChanged()
    {
        ApplyFilter();
        return Task.CompletedTask;
    }

    private void GoBack()
    {
        Nav.NavigateTo("/cargos");
    }
}

@page "/cargos"

<PageTitle>Cargos</PageTitle>

<RadzenStack Orientation="Orientation.Vertical" Gap="10px">
    <RadzenStack Orientation="Orientation.Horizontal" Gap="10px">
        <RadzenButton Text="Refresh" Click="LoadAsync" Icon="refresh" Style="margin-right:5px" />
        <RadzenButton Text="Add Cargo" Icon="add_circle" Click="OnAddCargo" />
    </RadzenStack>

    <RadzenDataGrid Data="cargos" TItem="Cargo" RowHover="true" AllowPaging="true" PageSize="10" AllowSorting="true">
        <Columns>
            <RadzenDataGridColumn TItem="Cargo" Property="Id" Title="Id" />
            <RadzenDataGridColumn TItem="Cargo" Property="Name" Title="Name" />
            <RadzenDataGridColumn TItem="Cargo" Property="From" Title="From" />
            <RadzenDataGridColumn TItem="Cargo" Property="To" Title="To" />
            <RadzenDataGridColumn TItem="Cargo" Property="DepartureAt" Title="Departure" />
            <RadzenDataGridColumn TItem="Cargo" Property="EstimatedArrivalAt" Title="ETA" />
            <RadzenDataGridColumn TItem="Cargo" Property="TrackId" Title="Track" />
        </Columns>
    </RadzenDataGrid>
</RadzenStack>

@code {
    [Inject] private CargoTracker.Web.Domain.Abstractions.IDataManagerApiClient Api { get; set; } = default!;
    [Inject] private Radzen.NotificationService Notifications { get; set; } = default!;
    [Inject] private Radzen.DialogService Dialogs { get; set; } = default!;

    private IReadOnlyList<Cargo> cargos = Array.Empty<Cargo>();

    protected override async Task OnInitializedAsync()
    {
        await LoadAsync();
    }

    private async Task LoadAsync()
    {
        try
        {
            cargos = await Api.GetCargosAsync();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Notifications.Notify(Radzen.NotificationSeverity.Error, "Failed to load cargos", ex.Message);
        }
    }

    private async Task OnAddCargo()
    {
        try
        {
            var result = await Dialogs.OpenAsync<CargoTracker.Web.Components.Dialogs.CargoCreateDialog>(
                title: "Создать груз",
                options: new Radzen.DialogOptions { Width = "600px", Resizable = true, Draggable = true }
            );

            if (result is Cargo newCargo)
            {
                // Ensure defaults for times if not set
                if (newCargo.DepartureAt == default) newCargo.DepartureAt = DateTimeOffset.UtcNow;
                if (newCargo.EstimatedArrivalAt == default) newCargo.EstimatedArrivalAt = newCargo.DepartureAt;

                var created = await Api.CreateCargoAsync(newCargo);
                Notifications.Notify(Radzen.NotificationSeverity.Success, $"Cargo '{created.Name}' created");
                await LoadAsync();
            }
        }
        catch (Exception ex)
        {
            Notifications.Notify(Radzen.NotificationSeverity.Error, "Failed to create cargo", ex.Message);
        }
    }
}
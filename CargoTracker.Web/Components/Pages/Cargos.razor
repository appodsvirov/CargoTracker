@page "/cargos"

<PageTitle>Cargos</PageTitle>

<RadzenStack Orientation="Orientation.Vertical" Gap="10px">
    <RadzenStack Orientation="Orientation.Horizontal" Gap="10px">
        <RadzenButton Text="Refresh" Click="LoadAsync" Icon="refresh" Style="margin-right:5px" />
        <RadzenButton Text="Add Cargo" Icon="add_circle" Click="OnAddCargo" />
    </RadzenStack>

    <RadzenDataGrid Data="cargos" TItem="CargoDto" RowHover="true" AllowPaging="true" PageSize="10" AllowSorting="true">
        <Columns>
            <RadzenDataGridColumn TItem="CargoDto" Property="Id" Title="Id" />
            <RadzenDataGridColumn TItem="CargoDto" Property="Name" Title="Name" />
            <RadzenDataGridColumn TItem="CargoDto" Property="From" Title="From" />
            <RadzenDataGridColumn TItem="CargoDto" Property="To" Title="To" />
            <RadzenDataGridColumn TItem="CargoDto" Property="DepartureAt" Title="Departure" />
            <RadzenDataGridColumn TItem="CargoDto" Property="EstimatedArrivalAt" Title="ETA" />
            <RadzenDataGridColumn TItem="CargoDto" Property="TrackId" Title="Track" />
        </Columns>
    </RadzenDataGrid>
</RadzenStack>

@code {
    [Inject] private CargoTracker.Web.Domain.Abstractions.IDataManagerApiClient Api { get; set; } = default!;
    [Inject] private Radzen.NotificationService Notifications { get; set; } = default!;

    private IReadOnlyList<CargoTracker.Web.Domain.Models.CargoDto> cargos = Array.Empty<CargoTracker.Web.Domain.Models.CargoDto>();

    protected override async Task OnInitializedAsync()
    {
        await LoadAsync();
    }

    private async Task LoadAsync()
    {
        try
        {
            cargos = await Api.GetCargosAsync();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Notifications.Notify(Radzen.NotificationSeverity.Error, "Failed to load cargos", ex.Message);
        }
    }

    private async Task OnAddCargo()
    {
        // Placeholder: Create a minimal cargo and post. In real UI, open dialog.
        var cargo = new CargoTracker.Web.Domain.Models.CargoDto
        {
            Id = Guid.NewGuid(),
            Name = "New cargo",
            From = "",
            To = "",
            DepartureAt = DateTimeOffset.UtcNow,
            EstimatedArrivalAt = DateTimeOffset.UtcNow.AddDays(3),
            TrackId = null
        };
        try
        {
            await Api.CreateCargoAsync(cargo);
            Notifications.Notify(Radzen.NotificationSeverity.Success, "Cargo created");
            await LoadAsync();
        }
        catch (Exception ex)
        {
            Notifications.Notify(Radzen.NotificationSeverity.Error, "Failed to create cargo", ex.Message);
        }
    }
}
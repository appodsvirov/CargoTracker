@page "/cargos"
@using CargoTracker.Web.Components.Shared

<PageTitle>Cargos</PageTitle>

<RadzenStack Orientation="Orientation.Vertical" Gap="10px">
    <RadzenStack Orientation="Orientation.Horizontal" Gap="10px">
        <RadzenButton Text="Refresh" Click="LoadAsync" Icon="refresh" Style="margin-right:5px" />
        <RadzenButton Text="Add Cargo" Icon="add_circle" Click="OnAddCargo" />
    </RadzenStack>

    <RadzenStack Orientation="Orientation.Horizontal" Gap="10px" AlignItems="AlignItems.Center">
        <RadzenTextBox @bind-Value="filterQuery" Placeholder="Поиск..." Style="width:300px"
            Change=OnFilterQueryChanged />
        <RadzenButton Text="Settings" Icon="settings" Click="OpenFilterSettings" ButtonStyle="ButtonStyle.Light" />
    </RadzenStack>

    <RadzenDataGrid Data="filteredCargos" TItem="Cargo" RowHover="true" AllowPaging="true" PageSize="10"
        AllowSorting="true">
        <Columns>
            <RadzenDataGridColumn TItem="Cargo" Title="Id" Width="100px" TextAlign="TextAlign.Center">
                <Template Context="c">
                    <CopyToClipboardButton TextToCopy="@c.Id.ToString()"/>
                </Template>
            </RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="Cargo" Property="Name" Title="Наименование" />
            <RadzenDataGridColumn TItem="Cargo" Property="From" Title="Откуда" />
            <RadzenDataGridColumn TItem="Cargo" Property="To" Title="Куда" />
            <RadzenDataGridColumn TItem="Cargo" Title="Departure">
                <Template Context="c">
                    <LocalDateTime Value="@c.DepartureAt" />
                </Template>
            </RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="Cargo" Title="ETA">
                <Template Context="c">
                    <LocalDateTime Value="@c.EstimatedArrivalAt" />
                </Template>
            </RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="Cargo" Title="Действия" Context="c">
                <Template Context="c">
                    <RadzenButton Icon="add_location" Size="ButtonSize.Small" Click="() => OnAddTrack(c)" Style="margin-right:6px" />
                    <RadzenButton Icon="list" Size="ButtonSize.Small" Click="() => OnShowTracks(c)" />
                </Template>
            </RadzenDataGridColumn>
        </Columns>
    </RadzenDataGrid>
</RadzenStack>

@code {
    [Inject] private CargoTracker.Web.Domain.Abstractions.IDataManagerApiClient Api { get; set; } = default!;
    [Inject] private Radzen.NotificationService Notifications { get; set; } = default!;
    [Inject] private Radzen.DialogService Dialogs { get; set; } = default!;
    [Inject] private CargoTracker.Web.Domain.Abstractions.ICargoFilterService FilterService { get; set; } = default!;
    [Inject] private NavigationManager Nav { get; set; } = default!;

    private IReadOnlyList<Cargo> cargos = Array.Empty<Cargo>();
    private IReadOnlyList<Cargo> filteredCargos = Array.Empty<Cargo>();

    private string? filterQuery;
    private CargoTracker.Web.Domain.Models.CargoFilterOptions filterOptions = CargoTracker.Web.Domain.Models.CargoFilterOptions.All;

    protected override async Task OnInitializedAsync()
    {
        await LoadAsync();
    }

    private async Task LoadAsync()
    {
        try
        {
            cargos = await Api.GetCargosAsync();
            ApplyFilter();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Notifications.Notify(Radzen.NotificationSeverity.Error, "Failed to load cargos", ex.Message);
        }
    }

    private void ApplyFilter()
    {
        filteredCargos = FilterService.Filter(cargos, filterQuery, filterOptions);
    }

    private Task OnFilterQueryChanged(object? _)
    {
        ApplyFilter();
        return Task.CompletedTask;
    }

    private async Task OpenFilterSettings()
    {
        var result = await Dialogs.OpenAsync<CargoTracker.Web.Components.Dialogs.CargoFilterSettingsDialog>(
            title: "Настройки фильтра",
            options: new Radzen.DialogOptions { Width = "500px", Resizable = true, Draggable = true },
            parameters: new Dictionary<string, object?>
            {
                [nameof(CargoTracker.Web.Components.Dialogs.CargoFilterSettingsDialog.Options)] = filterOptions
            });

        if (result is CargoTracker.Web.Domain.Models.CargoFilterOptions opts)
        {
            filterOptions = opts;
            ApplyFilter();
        }
    }

    private async Task OnAddCargo()
    {
        try
        {
            var result = await Dialogs.OpenAsync<CargoTracker.Web.Components.Dialogs.CargoCreateDialog>(
                title: "Создать груз",
                options: new Radzen.DialogOptions { Width = "600px", Resizable = true, Draggable = true }
            );

            if (result is Cargo newCargo)
            {
                // Ensure defaults for times if not set
                if (newCargo.DepartureAt == default) newCargo.DepartureAt = DateTimeOffset.UtcNow;
                if (newCargo.EstimatedArrivalAt == default) newCargo.EstimatedArrivalAt = newCargo.DepartureAt;

                var created = await Api.CreateCargoAsync(newCargo);
                Notifications.Notify(Radzen.NotificationSeverity.Success, $"Cargo '{created.Name}' created");
                await LoadAsync();
            }
        }
        catch (Exception ex)
        {
            Notifications.Notify(Radzen.NotificationSeverity.Error, "Failed to create cargo", ex.Message);
        }
    }

    private async Task OnAddTrack(Cargo c)
    {
        try
        {
            var result = await Dialogs.OpenAsync<CargoTracker.Web.Components.Dialogs.TrackCreateDialog>(
                title: "Добавить трек",
                options: new Radzen.DialogOptions { Width = "500px", Resizable = true, Draggable = true },
                parameters: new Dictionary<string, object?>
                {
                    [nameof(CargoTracker.Web.Components.Dialogs.TrackCreateDialog.CargoId)] = c.Id
                });

            if (result is Track t)
            {
                var created = await Api.CreateTrackAsync(t);
                Notifications.Notify(Radzen.NotificationSeverity.Success, $"Track added for cargo {c.Id}");
            }
        }
        catch (Exception ex)
        {
            Notifications.Notify(Radzen.NotificationSeverity.Error, "Failed to add track", ex.Message);
        }
    }

    private void OnShowTracks(Cargo c)
    {
        Nav.NavigateTo($"/cargos/{c.Id}/tracks");
    }
}